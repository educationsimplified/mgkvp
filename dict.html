<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual Dictionary</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to ensure Inter font and smooth transitions */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            display: flex;
            flex-direction: column; /* Column direction for header, main, footer */
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
            padding: 0; /* Remove body padding as elements will have their own */
            box-sizing: border-box;
        }

        /* Light theme defaults (applied to body) */
        body {
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark gray text */
        }

        /* Dark theme styles (applied when .dark-mode is on html) */
        html.dark-mode body {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }

        .container {
            max-width: 800px;
            width: 100%;
            padding: 2rem 1rem; /* Padding for mobile and desktop */
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .container.light-theme {
             background-color: #ffffff;
             border-color: #e5e7eb;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .container.dark-theme {
            background-color: #2d3748;
            border-color: #4a5568;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }


        /* Style for interactive elements on hover/focus */
        button, input[type="text"], select {
            transition: all 0.2s ease-in-out;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        input[type="text"]:focus, select:focus {
            border-color: #3b82f6; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Focus ring */
            outline: none;
        }

        /* Dark mode specific input/select styles */
        html.dark-mode input[type="text"],
        html.dark-mode select {
            background-color: #4a5568;
            border-color: #616e7f;
            color: #e2e8f0;
        }
        html.dark-mode input[type="text"]::placeholder {
            color: #a0aec0;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        html.dark-mode ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        html.dark-mode ::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        html.dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* Styling for the custom message box */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            display: none; /* Hidden by default */
            border: 1px solid #e5e7eb;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #messageBox.light-theme {
            background-color: white;
            border-color: #e5e7eb;
        }
        #messageBox.dark-theme {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        #messageBox.show {
            display: block;
        }
        #messageBoxBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Hidden by default */
        }
        #messageBoxBackdrop.show {
            display: block;
        }

        /* Specific text colors for dark mode within results and messages */
        html.dark-mode .text-gray-500 { color: #a0aec0; }
        html.dark-mode .text-gray-700 { color: #cbd5e0; }
        html.dark-mode .text-gray-800 { color: #e2e8f0; }
        html.dark-mode .text-gray-900 { color: #f8fafc; }
        html.dark-mode .text-red-600 { color: #fc8181; } /* Lighter red for dark mode */
        html.dark-mode .text-blue-600 { color: #63b3ed; } /* Lighter blue for dark mode */
        html.dark-mode .text-purple-700 { color: #b794f4; } /* Lighter purple for dark mode */

        html.dark-mode .bg-gray-50 { background-color: #2d3748; } /* Results background */
        html.dark-mode .border-gray-200 { border-color: #4a5568; }
        html.dark-mode .border-gray-100 { border-color: #4a5568; }

        /* Dark mode for suggestion buttons */
        html.dark-mode .suggestion-btn {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        html.dark-mode .suggestion-btn:hover {
            background-color: #616e7f;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Navigation Bar -->
    <nav class="w-full bg-blue-700 shadow-md py-4 mb-8 transition-colors duration-300">
        <div class="container mx-auto flex justify-between items-center px-4">
            <div class="text-white text-2xl font-bold">
                My Dictionary
            </div>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-white hover:text-blue-200 text-lg font-medium px-3 py-2 rounded-md transition duration-200 ease-in-out">Home</a>
                <a href="dictionary.html" class="text-blue-200 hover:text-white text-lg font-medium px-3 py-2 rounded-md transition duration-200 ease-in-out bg-blue-800">Dictionary</a>

                <!-- Theme Toggle Button -->
                <button
                    id="themeToggle"
                    class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white transition-colors duration-300 shadow-md"
                    aria-label="Toggle theme"
                >
                    <!-- Sun Icon for Light Mode -->
                    <svg id="sunIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h1M2 12h1m15.364 6.364l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707-.707M6.343 17.657l-.707.707M16 12a4 4 1 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <!-- Moon Icon for Dark Mode -->
                    <svg id="moonIcon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div id="mainContentContainer" class="container bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200 mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-blue-600 mb-6 transition-colors duration-300">
            Multilingual Dictionary
        </h1>

        <!-- Input and Controls Section -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <!-- Search Input -->
            <input
                type="text"
                id="wordInput"
                placeholder="Enter word here..."
                class="flex-grow p-3 md:p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg transition-colors duration-300"
            />

            <!-- Language Selector -->
            <select
                id="languageSelect"
                class="p-3 md:p-4 border border-gray-300 rounded-lg bg-white text-lg cursor-pointer appearance-none transition-colors duration-300"
            >
                <option value="en">English (US)</option>
                <option value="hi">Hindi</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="ar">Arabic</option>
                <option value="ru">Russian</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="zh">Chinese (Simplified)</option>
                <!-- Add more languages as supported by the API -->
            </select>

            <!-- Search Button -->
            <button
                id="searchButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center space-x-2 shadow-md hover:shadow-lg active:scale-95 transition-colors duration-300"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span>Search</span>
            </button>

            <!-- Voice Search Button -->
            <button
                id="voiceSearchButton"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center space-x-2 shadow-md hover:shadow-lg active:scale-95 transition-colors duration-300"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <span>Voice</span>
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center text-blue-500 font-semibold text-lg mb-4 hidden transition-colors duration-300">
            <svg class="animate-spin inline-block w-8 h-8 mr-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Searching...
        </div>

        <!-- Message/Error Display -->
        <div id="messageDisplay" class="text-center text-red-500 font-medium mb-4 transition-colors duration-300"></div>

        <!-- Results Display Area -->
        <div id="results" class="bg-gray-50 p-6 rounded-lg border border-gray-200 transition-colors duration-300">
            <p class="text-gray-500 text-center text-base md:text-lg">Search for a word to see its definition, pronunciation, and examples.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full bg-gray-800 text-white py-4 mt-auto transition-colors duration-300">
        <div class="container mx-auto text-center text-sm px-4">
            Made by Uzair Uzair B2B Services
        </div>
    </footer>

    <!-- Custom Message Box (instead of alert/confirm) -->
    <div id="messageBoxBackdrop" class="hidden"></div>
    <div id="messageBox" class="hidden">
        <p id="messageText" class="text-lg font-medium text-gray-800 mb-4 transition-colors duration-300"></p>
        <button id="messageBoxClose" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors duration-300">
            OK
        </button>
    </div>

    <script>
        // DOM Element References
        const htmlElement = document.documentElement;
        const bodyElement = document.body;
        const mainContentContainer = document.getElementById('mainContentContainer');
        const wordInput = document.getElementById('wordInput');
        const languageSelect = document.getElementById('languageSelect');
        const searchButton = document.getElementById('searchButton');
        const voiceSearchButton = document.getElementById('voiceSearchButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageDisplay = document.getElementById('messageDisplay');
        const resultsDiv = document.getElementById('results');
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const footerElement = document.querySelector('footer'); // Get footer element
        const navigationBar = document.querySelector('nav'); // Get navigation bar element


        // Custom Message Box Elements
        const messageBox = document.getElementById('messageBox');
        const messageBoxBackdrop = document.getElementById('messageBoxBackdrop');
        const messageText = document.getElementById('messageText');
        const messageBoxClose = document.getElementById('messageBoxClose');

        /**
         * Shows a custom message box.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBoxBackdrop.classList.add('show');
            messageBox.classList.add('show');
            // Ensure message box also respects current theme
            if (htmlElement.classList.contains('dark-mode')) {
                messageBox.classList.remove('light-theme');
                messageBox.classList.add('dark-theme');
            } else {
                messageBox.classList.remove('dark-theme');
                messageBox.classList.add('light-theme');
            }
        }

        // Close message box event listener
        messageBoxClose.addEventListener('click', () => {
            messageBoxBackdrop.classList.remove('show');
            messageBox.classList.remove('show');
        });

        // API Constants
        const DICTIONARY_API_BASE_URL = 'https://api.dictionaryapi.dev/api/v2/entries';
        const SUGGESTION_API_BASE_URL = 'https://geocoding-api.open-meteo.com/v1/search'; // Placeholder for spell check
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const GEMINI_API_KEY = ""; // Canvas will automatically provide this at runtime

        // Initialize Web Speech API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Only get one result per recognition start
            recognition.lang = 'en-US'; // Default language for speech recognition
            recognition.interimResults = false; // Only return final results

            // Event listener for when speech recognition results are available
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                wordInput.value = speechResult;
                searchWord(); // Trigger search automatically
            };

            // Event listener for speech recognition errors
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                messageDisplay.textContent = `Voice search error: ${event.error}`;
                if (event.error === 'not-allowed') {
                    showMessageBox('Voice search requires microphone permission. Please allow it in your browser settings.');
                } else if (event.error === 'no-speech') {
                    messageDisplay.textContent = 'No speech detected. Please try again.';
                }
                loadingIndicator.classList.add('hidden');
            };

            // Event listener for when speech recognition ends
            recognition.onend = () => {
                loadingIndicator.classList.add('hidden');
                messageDisplay.textContent = ''; // Clear any ongoing speech messages
            };

        } else {
            voiceSearchButton.disabled = true;
            voiceSearchButton.textContent = "Voice N/A";
            voiceSearchButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            voiceSearchButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            messageDisplay.textContent = 'Speech Recognition not supported in this browser.';
            console.warn('Web Speech API not supported in this browser.');
        }

        /**
         * Fetches word data from the dictionary API.
         * Implements exponential backoff for retries.
         * @param {string} word - The word to search for.
         * @param {string} language - The language code (e.g., 'en', 'es').
         * @param {number} retries - Number of retries remaining.
         * @param {number} delay - Current delay before retry.
         * @returns {Promise<Array>} - A promise that resolves with the dictionary data.
         */
        async function fetchWordData(word, language, retries = 3, delay = 1000) {
            const url = `${DICTIONARY_API_BASE_URL}/${language}/${word}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; // Word not found, return null to indicate this
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch failed, retrying in ${delay / 1000}s... (${retries} retries left)`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWordData(word, language, retries - 1, delay * 2); // Exponential backoff
                } else {
                    throw error; // No more retries, re-throw the error
                }
            }
        }

        /**
         * Fetches suggestions for a potentially misspelled word using a *placeholder* API.
         * This uses the Open-Meteo Geocoding API to find city names similar to the input.
         * @param {string} word - The word to get suggestions for.
         * @returns {Promise<Array<string>>} - A promise that resolves with an array of suggestions.
         */
        async function fetchSuggestions(word) {
            const url = `${SUGGESTION_API_BASE_URL}?name=${encodeURIComponent(word)}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // Extract relevant suggestions (e.g., city names)
                if (data.results && data.results.length > 0) {
                    // Get up to 5 unique city names as suggestions
                    const suggestions = [];
                    const seenNames = new Set();
                    for (const result of data.results) {
                        if (result.name && !seenNames.has(result.name)) {
                            suggestions.push(result.name);
                            seenNames.add(result.name);
                        }
                        if (suggestions.length >= 5) break; // Limit to 5 suggestions
                    }
                    return suggestions;
                }
                return [];
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                return []; // Return empty array on error
            }
        }

        /**
         * Calls the Gemini API to get an AI-powered explanation of a word.
         * Implements exponential backoff for retries.
         * @param {string} word - The word to explain.
         * @param {number} retries - Number of retries remaining.
         * @param {number} delay - Current delay before retry.
         * @returns {Promise<string>} - A promise that resolves with the explanation text.
         */
        async function getAIExplanation(word, retries = 3, delay = 1000) {
            const prompt = `Provide a brief, easy-to-understand explanation for the word: '${word}'. Focus on its core meaning and common usage. Keep it concise, suitable for a dictionary entry (around 50-100 words).`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(GEMINI_API_URL + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Gemini API call failed, retrying in ${delay / 1000}s... (${retries} retries left)`);
                    await new Promise(res => setTimeout(res, delay));
                    return getAIExplanation(word, retries - 1, delay * 2); // Exponential backoff
                } else {
                    throw error; // No more retries, re-throw the error
                }
            }
        }


        /**
         * Displays the search results in the UI.
         * @param {Array} data - The array of dictionary data.
         */
        function displayResults(data) {
            resultsDiv.innerHTML = ''; // Clear previous results

            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<p class="text-red-600 text-lg font-medium text-center">Sorry, we couldn\'t find definitions for that word.</p>';
                return;
            }

            // Display main word and phonetics
            const wordData = data[0]; // Assuming the first entry is the primary one
            const mainWord = wordData.word;
            let phoneticText = '';
            let audioUrl = '';

            // Find phonetic text and audio
            wordData.phonetics.forEach(phonetic => {
                if (phonetic.text && !phoneticText) {
                    phoneticText = phonetic.text;
                }
                if (phonetic.audio && phonetic.audio.startsWith('https://') && !audioUrl) { // Ensure https
                    audioUrl = phonetic.audio;
                }
            });

            const wordHeader = document.createElement('div');
            wordHeader.className = 'mb-4 pb-4 border-b border-gray-200 flex flex-wrap items-center justify-between gap-2';
            wordHeader.innerHTML = `
                <h2 class="text-4xl font-bold text-gray-900 capitalize break-words">${mainWord}</h2>
                <div class="flex items-center gap-3">
                    ${phoneticText ? `<span class="text-xl text-gray-600 font-mono">${phoneticText}</span>` : ''}
                    ${audioUrl ? `
                        <button id="pronounceButton" class="bg-blue-100 hover:bg-blue-200 text-blue-800 p-2 rounded-full shadow-sm hover:shadow-md active:scale-95 transition-colors duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9l1.414-1.414M7.071 17.071l-1.414 1.414M4 12H2m18 0h-2M5.636 5.636l-1.414-1.414M18.364 18.364l1.414 1.414M12 20v2m0-2v-2m0-10V2m0 2v2" />
                            </svg>
                        </button>
                    ` : ''}
                    <button id="aiExplainButton" data-word="${mainWord}" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-md flex items-center justify-center space-x-2 shadow-md hover:shadow-lg active:scale-95 transition-colors duration-300">
                        <span class="text-xl">✨</span> <span>Explain with AI</span>
                    </button>
                </div>
            `;
            resultsDiv.appendChild(wordHeader);

            // Add event listener for AI Explain button
            const aiExplainButton = wordHeader.querySelector('#aiExplainButton');
            if (aiExplainButton) {
                aiExplainButton.addEventListener('click', async () => {
                    const wordToExplain = aiExplainButton.dataset.word;
                    const aiExplanationDiv = document.getElementById('aiExplanation');
                    const aiExplanationLoading = document.getElementById('aiExplanationLoading');

                    aiExplanationDiv.innerHTML = ''; // Clear previous explanation
                    aiExplanationLoading.classList.remove('hidden'); // Show loading indicator
                    aiExplainButton.disabled = true; // Disable button while loading

                    try {
                        const explanation = await getAIExplanation(wordToExplain);
                        aiExplanationDiv.innerHTML = `
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <h3 class="text-xl font-semibold text-purple-700 mb-2">✨ AI-Powered Explanation:</h3>
                                <p class="text-lg text-gray-700 leading-relaxed">${explanation}</p>
                            </div>
                        `;
                        // Ensure newly added elements also respond to theme
                        applyTheme(htmlElement.classList.contains('dark-mode'));
                    } catch (error) {
                        console.error('Error fetching AI explanation:', error);
                        aiExplanationDiv.innerHTML = `
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <p class="text-red-600 text-lg font-medium text-center">Failed to get AI explanation. Please try again.</p>
                            </div>
                        `;
                    } finally {
                        aiExplanationLoading.classList.add('hidden'); // Hide loading
                        aiExplainButton.disabled = false; // Re-enable button
                    }
                });
            }


            if (audioUrl) {
                const pronounceButton = wordHeader.querySelector('#pronounceButton');
                if (pronounceButton) {
                    pronounceButton.addEventListener('click', () => {
                        const audio = new Audio(audioUrl);
                        audio.play().catch(e => console.error("Error playing audio:", e));
                    });
                }
            }

            // Display meanings (parts of speech, definitions, examples, synonyms)
            wordData.meanings.forEach(meaning => {
                const meaningSection = document.createElement('div');
                meaningSection.className = 'mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-100 transition-colors duration-300';
                meaningSection.innerHTML = `
                    <h3 class="text-2xl font-semibold text-purple-700 mb-3 capitalize">${meaning.partOfSpeech}</h3>
                `;

                meaning.definitions.forEach((def, index) => {
                    const definitionItem = document.createElement('div');
                    definitionItem.className = 'mb-3 pb-3 border-b border-gray-100 last:border-b-0 last:pb-0';
                    definitionItem.innerHTML = `
                        <p class="text-lg text-gray-700 leading-relaxed"><span class="font-bold text-gray-800">${index + 1}.</span> ${def.definition}</p>
                        ${def.example ? `<p class="text-gray-500 italic mt-1 pl-4">e.g., "${def.example}"</p>` : ''}
                    `;
                    meaningSection.appendChild(definitionItem);
                });

                if (meaning.synonyms && meaning.synonyms.length > 0) {
                    const synonymsDiv = document.createElement('div');
                    synonymsDiv.className = 'mt-4 pt-3 border-t border-gray-100';
                    synonymsDiv.innerHTML = `
                        <p class="text-md font-medium text-gray-600">Synonyms: <span class="text-blue-600 font-normal">${meaning.synonyms.slice(0, 5).join(', ')}${meaning.synonyms.length > 5 ? '...' : ''}</span></p>
                    `;
                    meaningSection.appendChild(synonymsDiv);
                }

                if (meaning.antonyms && meaning.antonyms.length > 0) {
                    const antonymsDiv = document.createElement('div');
                    antonymsDiv.className = 'mt-2';
                    antonymsDiv.innerHTML = `
                        <p class="text-md font-medium text-gray-600">Antonyms: <span class="text-red-600 font-normal">${meaning.antonyms.slice(0, 5).join(', ')}${meaning.antonyms.length > 5 ? '...' : ''}</span></p>
                    `;
                    meaningSection.appendChild(antonymsDiv);
                }

                resultsDiv.appendChild(meaningSection);
            });

            // Add div for AI explanation and its loading indicator
            resultsDiv.insertAdjacentHTML('beforeend', `
                <div id="aiExplanationLoading" class="text-center text-purple-500 font-semibold text-lg mt-6 hidden">
                    <svg class="animate-spin inline-block w-8 h-8 mr-2 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating AI explanation...
                </div>
                <div id="aiExplanation" class="mt-6"></div>
            `);
            // Ensure newly added elements also respond to theme
            applyTheme(htmlElement.classList.contains('dark-mode'));
        }

        /**
         * Initiates the word search process.
         */
        async function searchWord() {
            const word = wordInput.value.trim();
            const language = languageSelect.value;

            messageDisplay.textContent = ''; // Clear previous messages
            resultsDiv.innerHTML = '<p class="text-gray-500 text-center text-base md:text-lg">Searching...</p>'; // Show searching message
            loadingIndicator.classList.remove('hidden');
            // Ensure newly added results loading message responds to theme
            applyTheme(htmlElement.classList.contains('dark-mode'));


            if (!word) {
                showMessageBox('Please enter a word to search.');
                loadingIndicator.classList.add('hidden');
                resultsDiv.innerHTML = '<p class="text-gray-500 text-center text-base md:text-lg">Search for a word to see its definition, pronunciation, and examples.</p>';
                return;
            }

            try {
                const data = await fetchWordData(word, language);
                if (data === null) { // Word not found (404 response)
                    let notFoundMessage = `<p class="text-red-600 text-lg font-medium text-center">Sorry, we couldn't find definitions for "${word}" in ${language.toUpperCase()}.</p>`;
                    resultsDiv.innerHTML = notFoundMessage;

                    // Try to fetch suggestions if the word wasn't found
                    const suggestions = await fetchSuggestions(word);
                    if (suggestions.length > 0) {
                        const suggestionHtml = `
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <p class="text-gray-700 text-center text-lg font-semibold mb-2">Did you mean (demonstration using a place name API):</p>
                                <div class="flex flex-wrap justify-center gap-2">
                                    ${suggestions.map(s => `<button class="suggestion-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-md px-4 py-2 rounded-full">${s}</button>`).join('')}
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 text-center mt-2">Note: This "suggestion" feature is a demonstration using a placeholder API (Open-Meteo Geocoding API) which provides similar-sounding place names, not actual word spell checks. A dedicated spell check API would be needed for precise word corrections.</p>
                        `;
                        resultsDiv.insertAdjacentHTML('beforeend', suggestionHtml);

                        // Add event listeners to suggestion buttons
                        document.querySelectorAll('.suggestion-btn').forEach(button => {
                            button.addEventListener('click', (event) => {
                                wordInput.value = event.target.textContent;
                                searchWord();
                            });
                        });
                    }
                } else {
                    displayResults(data);
                }
                // Ensure all rendered elements have correct theme classes
                applyTheme(htmlElement.classList.contains('dark-mode'));
            } catch (error) {
                console.error('Error fetching dictionary data:', error);
                messageDisplay.textContent = 'Failed to fetch dictionary data. Please try again later.';
                resultsDiv.innerHTML = '<p class="text-red-600 text-lg font-medium text-center">An error occurred while fetching data. Please try again.</p>';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Starts the speech recognition for voice search.
         */
        function startVoiceSearch() {
            if (recognition) {
                messageDisplay.textContent = 'Listening... Please speak now.';
                loadingIndicator.classList.remove('hidden');
                try {
                    recognition.start();
                } catch (e) {
                    console.error('Speech recognition already in progress or failed to start:', e);
                    messageDisplay.textContent = 'Voice search is already active or an error occurred.';
                    loadingIndicator.classList.add('hidden');
                }
            } else {
                showMessageBox('Speech Recognition not supported in your browser.');
            }
        }

        /**
         * Toggles between light and dark themes.
         */
        function toggleTheme() {
            const isDarkMode = htmlElement.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme(isDarkMode);
        }

        /**
         * Applies the given theme to various elements on the page.
         * @param {boolean} isDarkMode - True if dark mode should be applied, false for light mode.
         */
        function applyTheme(isDarkMode) {
            // Toggle icons
            if (isDarkMode) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }

            // Apply theme classes to dynamic elements that don't auto-inherit from body/html
            mainContentContainer.classList.toggle('dark-theme', isDarkMode);
            mainContentContainer.classList.toggle('light-theme', !isDarkMode);

            messageBox.classList.toggle('dark-theme', isDarkMode);
            messageBox.classList.toggle('light-theme', !isDarkMode);

            // Update text colors for some specific elements not covered by general body styling
            const h1Element = mainContentContainer.querySelector('h1');
            if (h1Element) {
                if (isDarkMode) {
                    h1Element.classList.remove('text-blue-600');
                    h1Element.classList.add('text-blue-300'); // Lighter blue for dark mode
                } else {
                    h1Element.classList.remove('text-blue-300');
                    h1Element.classList.add('text-blue-600');
                }
            }

            const searchPlaceholder = wordInput;
            if (searchPlaceholder) {
                if (isDarkMode) {
                    searchPlaceholder.classList.remove('placeholder-gray-500'); // Default Tailwind placeholder
                    searchPlaceholder.classList.add('placeholder-gray-400'); // Lighter placeholder for dark mode
                } else {
                    searchPlaceholder.classList.remove('placeholder-gray-400');
                    searchPlaceholder.classList.add('placeholder-gray-500');
                }
            }

            // Iterate over elements that need manual class adjustments for dynamically generated content
            document.querySelectorAll('#results p, #results span, #results h2, #results h3, #results .bg-blue-100, #results .text-blue-800, #results .bg-gray-200, #results .text-gray-800, #results .text-red-600, #results .text-blue-600, #results .text-purple-700').forEach(el => {
                if (el.classList.contains('text-gray-500')) {
                    el.classList.toggle('text-gray-500', !isDarkMode);
                    el.classList.toggle('text-gray-400', isDarkMode);
                } else if (el.classList.contains('text-gray-700')) {
                    el.classList.toggle('text-gray-700', !isDarkMode);
                    el.classList.toggle('text-gray-300', isDarkMode);
                } else if (el.classList.contains('text-gray-800')) {
                     el.classList.toggle('text-gray-800', !isDarkMode);
                     el.classList.toggle('text-gray-200', isDarkMode);
                } else if (el.classList.contains('text-gray-900')) {
                     el.classList.toggle('text-gray-900', !isDarkMode);
                     el.classList.toggle('text-gray-100', isDarkMode);
                } else if (el.classList.contains('text-red-600')) {
                    el.classList.toggle('text-red-600', !isDarkMode);
                    el.classList.toggle('text-red-400', isDarkMode);
                } else if (el.classList.contains('text-blue-600')) {
                    el.classList.toggle('text-blue-600', !isDarkMode);
                    el.classList.toggle('text-blue-400', isDarkMode);
                } else if (el.classList.contains('text-purple-700')) {
                    el.classList.toggle('text-purple-700', !isDarkMode);
                    el.classList.toggle('text-purple-400', isDarkMode);
                } else if (el.classList.contains('bg-blue-100')) {
                    el.classList.toggle('bg-blue-100', !isDarkMode);
                    el.classList.toggle('bg-blue-900', isDarkMode);
                } else if (el.classList.contains('text-blue-800')) {
                    el.classList.toggle('text-blue-800', !isDarkMode);
                    el.classList.toggle('text-blue-200', isDarkMode);
                } else if (el.classList.contains('bg-gray-200') && el.classList.contains('suggestion-btn')) {
                    el.classList.toggle('bg-gray-200', !isDarkMode);
                    el.classList.toggle('bg-gray-700', isDarkMode);
                }
            });
             // Apply theme to loading indicators
             const loadingIcons = document.querySelectorAll('#loadingIndicator svg, #aiExplanationLoading svg');
             loadingIcons.forEach(icon => {
                 if (isDarkMode) {
                     icon.classList.remove('text-blue-500', 'text-purple-500');
                     icon.classList.add('text-blue-300', 'text-purple-300');
                 } else {
                     icon.classList.remove('text-blue-300', 'text-purple-300');
                     icon.classList.add('text-blue-500', 'text-purple-500');
                 }
             });

            // Update navigation bar and footer backgrounds explicitly
            if (isDarkMode) {
                navigationBar.classList.remove('bg-blue-700');
                navigationBar.classList.add('bg-gray-900');
                footerElement.classList.remove('bg-gray-800');
                footerElement.classList.add('bg-gray-900');
            } else {
                navigationBar.classList.remove('bg-gray-900');
                navigationBar.classList.add('bg-blue-700');
                footerElement.classList.remove('bg-gray-900');
                footerElement.classList.add('bg-gray-800');
            }
        }


        // Event Listeners
        searchButton.addEventListener('click', searchWord);
        wordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                searchWord();
            }
        });
        voiceSearchButton.addEventListener('click', startVoiceSearch);
        themeToggle.addEventListener('click', toggleTheme); // Event listener for theme toggle

        // Initial state
        resultsDiv.innerHTML = '<p class="text-gray-500 text-center text-base md:text-lg">Search for a word to see its definition, pronunciation, and examples.</p>';

        // Set the default language for speech recognition based on select dropdown
        languageSelect.addEventListener('change', () => {
            if (recognition) {
                recognition.lang = languageSelect.value + (languageSelect.value === 'en' ? '-US' : ''); // Adjust for specific locales if needed
            }
        });

        // Load theme from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                htmlElement.classList.add('dark-mode');
                applyTheme(true);
            } else {
                htmlElement.classList.remove('dark-mode');
                applyTheme(false);
            }
        });

    </script>
</body>
</html>
